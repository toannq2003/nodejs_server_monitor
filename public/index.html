<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenThread Packet Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">OpenThread Packet Monitor</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- CLI Command Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Gửi lệnh CLI</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="comPortSelect" class="form-label">Chọn COM Port</label>
                            <select class="form-select" id="comPortSelect">
                                <option value="">Chọn cổng COM...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="cliCommand" class="form-label">Lệnh CLI</label>
                            <input type="text" class="form-control" id="cliCommand" placeholder="Nhập lệnh CLI...">
                        </div>
                        <button class="btn btn-primary" id="sendCliBtn">Gửi</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>CLI Response</h5>
                    </div>
                    <div class="card-body">
                        <div class="cli-responses" id="cliResponses"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Packet Data Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Dữ liệu Packet</h5>
                <div>
                    <button class="btn btn-success btn-sm" id="refreshBtn">Làm mới</button>
                    <button class="btn btn-warning btn-sm" id="clearBtn">Xóa</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Timestamp</th>
                                <th>Packet Length</th>
                                <th>Kit Unique</th>
                                <th>Error Code</th>
                                <th>Is ACK</th>
                                <th>Channel</th>
                                <th>Packet Data</th>
                                <th>COM Port</th>
                            </tr>
                        </thead>
                        <tbody id="packetTableBody">
                            <!-- Dữ liệu sẽ được load bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        // Join room
        socket.emit('joinRoom', 'indexRoom');
        
        // Load packet data on page load
        socket.emit('requestPacketData');
        
        // Handle packet data response
        socket.on('packetData', (data) => {
            updatePacketTable(data);
        });
        
        // Handle new packet data
        socket.on('newPacketData', (data) => {
            addPacketToTable(data);
        });
        
        // Handle CLI response
        socket.on('cliResponse', (data) => {
            const cliResponses = document.getElementById('cliResponses');
            cliResponses.textContent += `[${data.comPort}] ${data.response}\n`;
            cliResponses.scrollTop = cliResponses.scrollHeight;
        });
        
        // Update COM port list
        socket.on('comList', (ports) => {
            const select = document.getElementById('comPortSelect');
            select.innerHTML = '<option value="">Chọn cổng COM...</option>';
            ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port.comPort;
                option.textContent = port.comPort;
                select.appendChild(option);
            });
        });
        
        // Send CLI command
        document.getElementById('sendCliBtn').addEventListener('click', () => {
            const comPort = document.getElementById('comPortSelect').value;
            const command = document.getElementById('cliCommand').value;
            
            if (comPort && command) {
                socket.emit('sendCli', { comPort, command });
                document.getElementById('cliCommand').value = '';
            } else {
                alert('Vui lòng chọn COM port và nhập lệnh!');
            }
        });
        
        // Refresh packet data
        document.getElementById('refreshBtn').addEventListener('click', () => {
            socket.emit('requestPacketData');
        });
        
        // Clear table
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('packetTableBody').innerHTML = '';
        });
        
        // Update packet table
        function updatePacketTable(data) {
            const tbody = document.getElementById('packetTableBody');
            tbody.innerHTML = '';
            
            data.forEach(packet => {
                addPacketToTable(packet);
            });
        }
        
        // Add single packet to table
        function addPacketToTable(packet) {
            const tbody = document.getElementById('packetTableBody');
            const row = document.createElement('tr');
            
            // Format timestamp
            const timestamp = new Date(packet.timestamp).toLocaleString('vi-VN');
            
            // Truncate packet data if too long
            const packetData = packet.packet_data.length > 50 ? 
                packet.packet_data.substring(0, 50) + '...' : 
                packet.packet_data;
            
            row.innerHTML = `
                <td>${packet.id || 'N/A'}</td>
                <td><span class="badge ${packet.type === 'TX' ? 'bg-success' : 'bg-info'}">${packet.type}</span></td>
                <td>${timestamp}</td>
                <td>${packet.packet_length || packet.packetLength}</td>
                <td><code>${packet.kit_unique || packet.kitUnique}</code></td>
                <td>${packet.error_code || packet.errorCode}</td>
                <td>${(packet.is_ack || packet.isAck) ? 'Yes' : 'No'}</td>
                <td>${packet.channel}</td>
                <td><code title="${packet.packet_data || packet.packetData}">${packetData}</code></td>
                <td>${packet.com_port || packet.comPort}</td>
            `;
            
            // Insert at the beginning of the table
            tbody.insertBefore(row, tbody.firstChild);
            
            // Limit table rows to 100
            if (tbody.children.length > 100) {
                tbody.removeChild(tbody.lastChild);
            }
        }
        
        // Request COM port list on load
        socket.emit('requestComList');
        
        // Handle Enter key in CLI command input
        document.getElementById('cliCommand').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendCliBtn').click();
            }
        });
    </script>
</body>
</html>
