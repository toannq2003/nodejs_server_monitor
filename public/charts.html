<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biểu đồ - OpenThread Kit Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-microchip me-2"></i>OpenThread Kit Monitor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Dashboard</a>
                <a class="nav-link" href="/details"><i class="fas fa-list me-1"></i>Chi tiết Log</a>
                <a class="nav-link active" href="/charts"><i class="fas fa-chart-line me-1"></i>Biểu đồ</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Bộ lọc -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Bộ lọc dữ liệu</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Chọn Kits:</label>
                                <select id="kit-filter" class="form-select" multiple>
                                    <!-- Sẽ được cập nhật bằng JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Khoảng thời gian:</label>
                                <select id="time-range" class="form-select">
                                    <option value="1h">1 giờ qua</option>
                                    <option value="24h" selected>24 giờ qua</option>
                                    <option value="7d">7 ngày qua</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="update-charts" class="btn btn-success w-100">
                                    <i class="fas fa-sync-alt me-1"></i>Cập nhật biểu đồ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Biểu đồ RSSI -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-signal me-2"></i>Biểu đồ RSSI theo thời gian</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="rssi-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Biểu đồ LQI -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Biểu đồ LQI theo thời gian</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="lqi-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const socket = io();
        socket.emit('joinRoom', 'chartsRoom');

        let rssiChart, lqiChart;
        let chartData = [];

        // Khởi tạo biểu đồ
        function initCharts() {
            const rssiCtx = document.getElementById('rssi-chart').getContext('2d');
            const lqiCtx = document.getElementById('lqi-chart').getContext('2d');

            rssiChart = new Chart(rssiCtx, {
                type: 'line',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'HH:mm'
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'RSSI (dBm)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });

            lqiChart = new Chart(lqiCtx, {
                type: 'line',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'HH:mm'
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'LQI'
                            },
                            min: 0,
                            max: 255
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        // Cập nhật biểu đồ
        function updateCharts(data) {
            const kitGroups = {};
            
            // Nhóm dữ liệu theo kit
            data.forEach(item => {
                if (!kitGroups[item.kit_unique_id]) {
                    kitGroups[item.kit_unique_id] = [];
                }
                kitGroups[item.kit_unique_id].push({
                    x: new Date(item.server_timestamp),
                    rssi: item.rssi,
                    lqi: item.lqi
                });
            });

            // Tạo datasets cho RSSI
            const rssiDatasets = Object.keys(kitGroups).map((kitId, index) => {
                const color = getKitColor(index);
                return {
                    label: kitId,
                    data: kitGroups[kitId].map(item => ({ x: item.x, y: item.rssi })),
                    borderColor: color,
                    backgroundColor: color + '20',
                    fill: false
                };
            });

            // Tạo datasets cho LQI
            const lqiDatasets = Object.keys(kitGroups).map((kitId, index) => {
                const color = getKitColor(index);
                return {
                    label: kitId,
                    data: kitGroups[kitId].map(item => ({ x: item.x, y: item.lqi })),
                    borderColor: color,
                    backgroundColor: color + '20',
                    fill: false
                };
            });

            rssiChart.data.datasets = rssiDatasets;
            lqiChart.data.datasets = lqiDatasets;
            
            rssiChart.update();
            lqiChart.update();
        }

        function getKitColor(index) {
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            return colors[index % colors.length];
        }

        // Sự kiện socket
        socket.on('chartData', (data) => {
            chartData = data;
            updateCharts(data);
        });

        socket.on('newChartData', (newData) => {
            // Thêm dữ liệu mới vào biểu đồ real-time
            if (newData.rssi !== null && newData.lqi !== null) {
                chartData.push({
                    kit_unique_id: newData.kitUniqueId,
                    rssi: newData.rssi,
                    lqi: newData.lqi,
                    server_timestamp: newData.timestamp
                });
                
                // Giới hạn số lượng điểm dữ liệu
                if (chartData.length > 1000) {
                    chartData = chartData.slice(-1000);
                }
                
                updateCharts(chartData);
            }
        });

        // Cập nhật bộ lọc kit
        socket.on('kitsList', (kits) => {
            const select = document.getElementById('kit-filter');
            const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);
            
            select.innerHTML = '';
            
            kits.forEach(kit => {
                const option = document.createElement('option');
                option.value = kit.unique_id;
                option.textContent = kit.unique_id;
                if (selectedValues.includes(kit.unique_id)) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        });

        // Sự kiện cập nhật biểu đồ
        document.getElementById('update-charts').addEventListener('click', () => {
            const selectedKits = Array.from(document.getElementById('kit-filter').selectedOptions)
                .map(opt => opt.value);
            const timeRange = document.getElementById('time-range').value;
            
            socket.emit('requestChartData', {
                kitIds: selectedKits,
                timeRange: timeRange
            });
        });

        // Khởi tạo
        initCharts();
        socket.emit('requestKitsList');
        socket.emit('requestChartData', { timeRange: '24h' });
    </script>
</body>
</html>
