<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenThread Monitoring - Charts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Thêm Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-blue-900 text-white shadow-md">
        <div class="container max-w-4xl">
            <a class="navbar-brand font-extrabold text-xl" href="#">OpenThread Monitoring</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link text-gray-200 hover:text-blue-300" href="index.html">Dashboard</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-gray-200 hover:text-blue-300" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Menu
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="charts.html">Đồ thị</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-6 max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Biểu đồ RSSI</h1>
        <div class="card shadow-lg mb-6">
            <div class="card-body p-4">
                <div><canvas id="rssiChart"></canvas></div>
            </div>
        </div>

        <h1 class="text-3xl font-bold text-gray-900 mb-6">Biểu đồ LQI</h1>
        <div class="card shadow-lg mb-6">
            <div class="card-body p-4">
                <div><canvas id="lqiChart"></canvas></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        socket.emit('joinRoom', 'dashboardRoom');

        let chartData = [];
        let rssiChart, lqiChart;

        function updateCharts(data) {
            const normalizedData = {
                comPort: data.comPort || data.com_port || 'Unknown',
                rssi: data.rssi || 0,
                lqi: data.lqi || 0,
                timestamp: data.timestamp || new Date().toISOString()
            };
            chartData.push(normalizedData);

            if (chartData.length > 20) {
                chartData.shift();
            }

            const groupedData = chartData.reduce((acc, item) => {
                if (!acc[item.comPort]) {
                    acc[item.comPort] = { timestamps: [], rssi: [], lqi: [] };
                }
                acc[item.comPort].timestamps.push(new Date(item.timestamp).toLocaleTimeString());
                acc[item.comPort].rssi.push(item.rssi);
                acc[item.comPort].lqi.push(item.lqi);
                return acc;
            }, {});

            const comPorts = Object.keys(groupedData);
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD'];

            const rssiDatasets = comPorts.map((port, index) => ({
                label: port,
                data: groupedData[port].rssi,
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '80',
                fill: false,
                tension: 0.1
            }));

            const lqiDatasets = comPorts.map((port, index) => ({
                label: port,
                data: groupedData[port].lqi,
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '80',
                fill: false,
                tension: 0.1
            }));

            if (!rssiChart) {
                const rssiChartConfig = {
                    type: 'line',
                    data: {
                        labels: groupedData[comPorts[0]]?.timestamps || [],
                        datasets: rssiDatasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'RSSI theo thời gian' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Thời gian' } },
                            y: { title: { display: true, text: 'RSSI (dBm)' }, beginAtZero: true }
                        }
                    }
                };
                rssiChart = new Chart(document.getElementById('rssiChart'), rssiChartConfig);
            } else {
                rssiChart.data.labels = groupedData[comPorts[0]]?.timestamps || [];
                rssiChart.data.datasets = rssiDatasets;
                rssiChart.update();
            }

            if (!lqiChart) {
                const lqiChartConfig = {
                    type: 'line',
                    data: {
                        labels: groupedData[comPorts[0]]?.timestamps || [],
                        datasets: lqiDatasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'LQI theo thời gian' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Thời gian' } },
                            y: { title: { display: true, text: 'LQI' }, beginAtZero: true }
                        }
                    }
                };
                lqiChart = new Chart(document.getElementById('lqiChart'), lqiChartConfig);
            } else {
                lqiChart.data.labels = groupedData[comPorts[0]]?.timestamps || [];
                lqiChart.data.datasets = lqiDatasets;
                lqiChart.update();
            }
        }

        socket.emit('requestChartData');

        socket.on('chartData', (data) => {
            chartData = data.map(item => ({
                comPort: item.comPort,
                rssi: item.rssi,
                lqi: item.lqi,
                timestamp: item.timestamp
            }));
            if (chartData.length > 0) {
                updateCharts(chartData[chartData.length - 1]);
            }
        });

        socket.on('newComData', (data) => {
            updateCharts(data);
        });
    </script>
</body>
</html>